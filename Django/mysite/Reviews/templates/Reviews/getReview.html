<!DOCTYPE html>
<html lang="en">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
{% load static %}
<link rel="stylesheet" href="{% static 'Reviews/custom.css'%}">
<head>
   <meta charset="UTF-8">
   <title>Get Reviews</title>
   <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>
</head>
<body>
  <div class="dropdown" style="float:right;">
    <button class="dropbtn">Menu</button>
    <div class="dropdown-content">
    <a href="#">Home</a>
    <a href="/reviews">Review A Place</a>
    <a href="/reviews/displayReviews">Listen to Reviews</a>
    </div>
  </div>
  <div class="container"><form>
   <div class="form-group"><h1><br>Search for Reviews</h1></div>
   <br>
 </form></div>
   <div id="resultsDiv"></div>
<script
 src="https://code.jquery.com/jquery-3.3.1.js"
 integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
 crossorigin="anonymous"></script>

<script src='https://code.responsivevoice.org/responsivevoice.js'></script>
<script type="text/javascript">
$(document).ready(function() {
    responsiveVoice.speak("What location would you like reviews for?");
    setTimeout(function() {
        console.log("finished sleeping");
        askSearch();
    }, 2500);

    function askSearch() {
        console.log("Request incomming")
        $.ajax({
            type: 'GET',
            url: "/reviews/getAudio/",
            dataType: 'json',
            success: function(data) {
                console.log(data);
                getReviews(data.message)
            }
        })
    }

    function getReviews(message) {
        var search = message;
        $.ajax({
            type: 'GET',
            url: "/reviews/getReviews/" + search.toLowerCase() + "/",
            dataType: 'json',
            success: async function (data) {
                console.log(data);
                $('#resultsDiv').html("");
                if(data.return == "No Data"){
                    responsiveVoice.speak("Sorry, no reviews were found for this location. please try again.")
                    setTimeout(function(){
                        location.reload();
                    }, 5000);

                }
                else{
                    getReviews2(data);
                }
                // for (var i = 0; i < data.length; i++) {
                //     var text = data[i].fields.reviewText;
                //     var loc = data[i].fields.location;
                //     var auth = data[i].fields.location;
                //     var up = data[i].fields.upvotes;
                //     var dt = data[i].fields.datePosted;
                //     var id=data[i].pk;
                //
                //         $('#resultsDiv').append(
                //             "<p><strong>Review:</strong>"+text+"</p>" +
                //             "<p><strong>Location:</strong>"+loc+"</p>" +
                //             "<p><strong>Author:</strong>"+auth+"</p>" +
                //             "<p><strong>Up-votes: </strong>"+up+"</p>" +
                //             "<p>"+dt+"</p>"+
                //             "<hr>");
                //             responsiveVoice.speak(text);
                //             console.log(id)
                //             setTimeout(function(){
                //                 askUpVoteFunc(id);
                //             },3000);
                //     //},5000);
                // }
            }
        });
    }

    function getReviews2(data){
        if (data.length == 0) return;
        var element = data[0];
        data.shift();


        var loc = element.fields.location;
        var auth = element.fields.author;
        var up = element.fields.upvotes;
        var dt = element.fields.datePosted;

        var text = auth + " has written: " +
                   element.fields.reviewText + "."
                   + " this review was upvoted "
                   + up + " times.";

        var id=element.pk;
        $('#resultsDiv').append(
            "<p><strong>Review:</strong>"+element.fields.reviewText+"</p>" +
            "<p><strong>Location:</strong>"+loc+"</p>" +
            "<p><strong>Author:</strong>"+auth+"</p>" +
            "<p><strong>Up-votes: </strong>"+up+"</p>" +
            "<p>"+dt+"</p>"+
            "<hr>");

        responsiveVoice.speak(text);
        setTimeout(function(){
            askUpVoteFunc(id,data);

        },9000);

    }

        function askUpVoteFunc(review,data1) {
            responsiveVoice.speak("was this helpful?");

            setTimeout(function() {
                console.log("Request incomming");
                $.ajax({
                    type: 'GET',
                    url: "/reviews/getAudio/",
                    dataType: 'json',
                    success: function(data) {upVote(review, data.message,data1);}
                });
            },1750);
        }

        function upVote(review, message,data){
            responsiveVoice.speak("thank you for your feedback.")
            setTimeout(function() {
                if(message.includes("yes") || message.includes("helpful") || message.includes("helpful")){
                    $.ajax({
                        type: 'POST',
                        url: '/reviews/incrementupvote/',
                        dataType: 'json',
                        data: {'idd': review},
                        success: function(data) {}
                    });
                }
                getReviews2(data);
            },1500);
        }

        function askForMore() {
            console.log("Request incomming");
            return $.ajax({
                type: 'GET',
                url: "/reviews/getAudio/",
                dataType: 'json',
                success: function(data) {
                    console.log(data.message);
                    if(data.message.includes("yes") || data.message.includes("helpful")){
                        console.log("continuing ...")
                        return true;
                    }
                    return false;
                }
            })
        }




    });
</script>
</body>
</html>
